"""Модели базы данных для архива обращений граждан."""
from datetime import date, datetime
from flask_sqlalchemy import SQLAlchemy
from flask_login import UserMixin
from werkzeug.security import generate_password_hash, check_password_hash

db = SQLAlchemy()


class AppealCategory(db.Model):
    """Категория обращений граждан."""
    __tablename__ = 'appeal_categories'
    
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(200), nullable=False)
    description = db.Column(db.Text)
    
    # Связь с обращениями
    appeals = db.relationship('Appeal', backref='category', lazy=True)
    
    def __repr__(self):
        return f'<AppealCategory {self.name}>'


class Appeal(db.Model):
    """Архивное обращение гражданина."""
    __tablename__ = 'appeals'
    
    id = db.Column(db.Integer, primary_key=True)
    category_id = db.Column(db.Integer, db.ForeignKey('appeal_categories.id'), nullable=False)
    date = db.Column(db.Date, nullable=False)
    register_number = db.Column(db.String(50), nullable=False)
    subject = db.Column(db.String(300), nullable=False)
    status = db.Column(db.String(100), nullable=False)
    short_summary = db.Column(db.Text)
    
    def __repr__(self):
        return f'<Appeal {self.register_number}>'


class User(UserMixin, db.Model):
    """Модель пользователя для авторизации."""
    __tablename__ = 'users'
    
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(80), unique=True, nullable=False)
    password_hash = db.Column(db.String(255), nullable=False)
    role = db.Column(db.String(20), nullable=False, default='user')
    
    def set_password(self, password):
        """Установка хеша пароля."""
        self.password_hash = generate_password_hash(password)
    
    def check_password(self, password):
        """Проверка пароля."""
        return check_password_hash(self.password_hash, password)
    
    @property
    def is_admin(self):
        """Проверка, является ли пользователь администратором."""
        return self.role == 'admin'
    
    def __repr__(self):
        return f'<User {self.username}>'


class News(db.Model):
    """Модель новостей архива."""
    __tablename__ = 'news'
    
    id = db.Column(db.Integer, primary_key=True)
    title = db.Column(db.String(200), nullable=False)
    content = db.Column(db.Text, nullable=False)
    created_at = db.Column(db.DateTime, nullable=False, default=datetime.utcnow)
    
    def __repr__(self):
        return f'<News {self.title}>'


def init_db():
    """Инициализация базы данных: создание таблиц и заполнение тестовыми данными."""
    # Удаляем все таблицы и создаем заново (для обновления схемы)
    db.drop_all()
    db.create_all()
    
    # Проверяем, есть ли уже данные категорий
    categories_exist = AppealCategory.query.first() is not None
    users_exist = User.query.first() is not None
    news_exist = News.query.first() is not None
    
    # Если все данные уже есть, выходим
    if categories_exist and users_exist and news_exist:
        return
    
    # Создаем категории обращений (только если их еще нет)
    if not categories_exist:
        categories = [
        AppealCategory(
            name='Обращения по вопросам жилищно-коммунального хозяйства',
            description='Обращения граждан, связанные с вопросами содержания жилищного фонда, предоставления коммунальных услуг, капитального ремонта, управления многоквартирными домами.'
        ),
        AppealCategory(
            name='Обращения по вопросам благоустройства территории',
            description='Обращения граждан по вопросам содержания и благоустройства городских территорий, озеленения, освещения, организации парковок и пешеходных зон.'
        ),
        AppealCategory(
            name='Обращения по вопросам социальной защиты населения',
            description='Обращения граждан по вопросам предоставления мер социальной поддержки, социальных выплат, льгот и компенсаций различным категориям граждан.'
        ),
        AppealCategory(
            name='Обращения по вопросам образования',
            description='Обращения граждан по вопросам организации образовательного процесса, приема в образовательные учреждения, качества предоставляемых образовательных услуг.'
        ),
        AppealCategory(
            name='Обращения по вопросам дорожной деятельности',
            description='Обращения граждан по вопросам содержания автомобильных дорог, организации дорожного движения, обустройства пешеходных переходов и остановок общественного транспорта.'
        )
    ]
    
        for category in categories:
            db.session.add(category)
        
        db.session.commit()
    
    # Создаем обращения (только если их еще нет)
    if not categories_exist:
        appeals_data = [
        # ЖКХ
        {
            'category_id': 1,
            'date': date(2023, 1, 15),
            'register_number': 'АРХ-2023-001',
            'subject': 'Вопрос о проведении капитального ремонта кровли многоквартирного дома',
            'status': 'Рассмотрено',
            'short_summary': 'Обращение по вопросу включения многоквартирного дома в программу капитального ремонта. Проведена проверка технического состояния кровли. Принято решение о включении объекта в план работ на 2024 год.'
        },
        {
            'category_id': 1,
            'date': date(2023, 2, 20),
            'register_number': 'АРХ-2023-045',
            'subject': 'Жалоба на качество предоставления услуг по отоплению',
            'status': 'Направлено по подведомственности',
            'short_summary': 'Обращение о недостаточной температуре в жилых помещениях в отопительный период. Материалы направлены в управляющую компанию для проведения проверки и принятия мер.'
        },
        {
            'category_id': 1,
            'date': date(2023, 3, 10),
            'register_number': 'АРХ-2023-078',
            'subject': 'Вопрос об организации управления многоквартирным домом',
            'status': 'На рассмотрении',
            'short_summary': 'Обращение по вопросу выбора способа управления многоквартирным домом и организации общего собрания собственников помещений.'
        },
        # Благоустройство
        {
            'category_id': 2,
            'date': date(2023, 4, 5),
            'register_number': 'АРХ-2023-112',
            'subject': 'Предложение об установке детской площадки во дворе жилого дома',
            'status': 'Рассмотрено',
            'short_summary': 'Обращение с предложением об установке детской игровой площадки. Проведено обследование территории. Принято решение о включении объекта в план благоустройства на 2024 год.'
        },
        {
            'category_id': 2,
            'date': date(2023, 5, 18),
            'register_number': 'АРХ-2023-156',
            'subject': 'Жалоба на отсутствие освещения на пешеходной дорожке',
            'status': 'Рассмотрено',
            'short_summary': 'Обращение об отсутствии уличного освещения на пешеходной дорожке, соединяющей жилые дома с остановкой общественного транспорта. Установлены светильники.'
        },
        {
            'category_id': 2,
            'date': date(2023, 6, 22),
            'register_number': 'АРХ-2023-189',
            'subject': 'Вопрос об организации парковочных мест для жителей',
            'status': 'На рассмотрении',
            'short_summary': 'Обращение по вопросу организации парковочных мест для жителей многоквартирных домов в связи с увеличением количества транспортных средств.'
        },
        # Социальная защита
        {
            'category_id': 3,
            'date': date(2023, 7, 8),
            'register_number': 'АРХ-2023-201',
            'subject': 'Вопрос о предоставлении мер социальной поддержки многодетным семьям',
            'status': 'Рассмотрено',
            'short_summary': 'Обращение по вопросу предоставления льгот и компенсаций многодетным семьям. Разъяснен порядок оформления документов и обращения в уполномоченные органы.'
        },
        {
            'category_id': 3,
            'date': date(2023, 8, 14),
            'register_number': 'АРХ-2023-234',
            'subject': 'Жалоба на отказ в предоставлении социальной выплаты',
            'status': 'Направлено по подведомственности',
            'short_summary': 'Обращение об отказе в предоставлении социальной выплаты. Материалы направлены в управление социальной защиты населения для пересмотра решения.'
        },
        # Образование
        {
            'category_id': 4,
            'date': date(2023, 9, 3),
            'register_number': 'АРХ-2023-267',
            'subject': 'Вопрос о зачислении ребенка в образовательное учреждение',
            'status': 'Рассмотрено',
            'short_summary': 'Обращение по вопросу зачисления ребенка в образовательное учреждение по месту жительства. Разъяснен порядок приема и предоставлены консультации.'
        },
        {
            'category_id': 4,
            'date': date(2023, 10, 11),
            'register_number': 'АРХ-2023-289',
            'subject': 'Жалоба на качество организации питания в школьной столовой',
            'status': 'Направлено по подведомственности',
            'short_summary': 'Обращение о качестве организации питания обучающихся. Материалы направлены в управление образования для проведения проверки.'
        },
        # Дорожная деятельность
        {
            'category_id': 5,
            'date': date(2023, 11, 7),
            'register_number': 'АРХ-2023-301',
            'subject': 'Предложение об обустройстве пешеходного перехода',
            'status': 'Рассмотрено',
            'short_summary': 'Обращение с предложением об обустройстве нерегулируемого пешеходного перехода светофором. Проведено обследование участка дороги. Принято решение об установке светофорного объекта.'
        },
        {
            'category_id': 5,
            'date': date(2023, 12, 15),
            'register_number': 'АРХ-2023-334',
            'subject': 'Жалоба на состояние дорожного покрытия',
            'status': 'На рассмотрении',
            'short_summary': 'Обращение о неудовлетворительном состоянии дорожного покрытия на участке автомобильной дороги. Проводится обследование для включения в план ремонтных работ.'
        },
        {
            'category_id': 5,
            'date': date(2024, 1, 20),
            'register_number': 'АРХ-2024-012',
            'subject': 'Вопрос об организации остановки общественного транспорта',
            'status': 'Рассмотрено',
            'short_summary': 'Обращение по вопросу обустройства остановочного пункта общественного транспорта. Выполнены работы по установке павильона ожидания и информационных указателей.'
        },
        {
            'category_id': 1,
            'date': date(2024, 2, 5),
            'register_number': 'АРХ-2024-045',
            'subject': 'Жалоба на работу управляющей компании',
            'status': 'Направлено по подведомственности',
            'short_summary': 'Обращение о ненадлежащем выполнении управляющей компанией обязанностей по содержанию общего имущества многоквартирного дома. Материалы направлены в жилищную инспекцию.'
        },
        {
            'category_id': 2,
            'date': date(2024, 3, 12),
            'register_number': 'АРХ-2024-078',
            'subject': 'Предложение о благоустройстве сквера',
            'status': 'На рассмотрении',
            'short_summary': 'Обращение с предложением о проведении работ по благоустройству городского сквера: установка скамеек, обновление покрытия пешеходных дорожек, высадка зеленых насаждений.'
        }
        ]
        
        for appeal_data in appeals_data:
            appeal = Appeal(**appeal_data)
            db.session.add(appeal)
        
        db.session.commit()
    
    # Создаем пользователей (только если их еще нет)
    if not users_exist:
        # Администратор: логин admin, пароль admin123
        admin_user = User(username='admin', role='admin')
        admin_user.set_password('admin123')
        db.session.add(admin_user)
        
        # Обычный пользователь: логин user, пароль user123
        regular_user = User(username='user', role='user')
        regular_user.set_password('user123')
        db.session.add(regular_user)
        
        db.session.commit()
    
    # Создаем новости (только если их еще нет)
    if not news_exist:
        news_items = [
            News(
                title='Обновление системы учета обращений граждан',
                content='В целях повышения эффективности работы с обращениями граждан администрация города N внедрила обновленную систему электронного учета и регистрации обращений. Новая система обеспечивает более оперативную обработку поступивших обращений и улучшенный контроль за сроками их рассмотрения.',
                created_at=datetime(2024, 1, 15, 10, 0)
            ),
            News(
                title='Изменения в порядке подачи обращений',
                content='С 1 февраля 2024 года вступают в силу изменения в порядке подачи обращений граждан в администрацию города N. Обращения могут быть поданы лично, по почте, через официальный сайт администрации или через многофункциональные центры предоставления государственных и муниципальных услуг.',
                created_at=datetime(2024, 2, 1, 14, 30)
            ),
            News(
                title='Проведение плановой проверки архивных документов',
                content='В соответствии с планом работы городского архива обращений граждан в марте 2024 года будет проведена плановая проверка архивных документов за 2023 год. Проверка направлена на обеспечение сохранности документов и соответствие их требованиям архивного законодательства.',
                created_at=datetime(2024, 2, 20, 9, 15)
            ),
            News(
                title='Расширение категорий обращений граждан',
                content='С целью более точной систематизации обращений граждан в архивную систему добавлены новые категории обращений, связанные с вопросами цифровизации городских услуг и развития информационной инфраструктуры города.',
                created_at=datetime(2024, 3, 5, 11, 45)
            ),
            News(
                title='Организация обучения сотрудников архива',
                content='В целях повышения квалификации сотрудников городского архива обращений граждан организованы обучающие семинары по работе с современными системами электронного документооборота и требованиям законодательства в области обработки персональных данных.',
                created_at=datetime(2024, 3, 18, 16, 20)
            )
        ]
        
        for news_item in news_items:
            db.session.add(news_item)
        
        db.session.commit()
    
    print('База данных успешно инициализирована.')

